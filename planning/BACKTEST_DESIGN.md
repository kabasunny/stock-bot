# バックテスト環境 設計書

## 1. 目的

本ドキュメントは、開発した取引戦略の有効性を客観的に評価し、パラメータの最適化を行うためのバックテスト環境の設計を定義する。
この環境を構築することで、以下の目的を達成する。

-   **戦略の有効性検証**: 新規に開発した取引戦略が、過去の市場データに対して利益を生む可能性があるかを定量的に評価する。
-   **パラメータ最適化**: 戦略に含まれる各種パラメータ（例: ATRの期間、リスク許容率）を変化させた場合に、パフォーマンスがどのように変わるかを分析し、最適な組み合わせを見つけ出す。
-   **リスク評価**: 戦略が持つ潜在的なリスク（例: 最大ドローダウン、連敗回数）を事前に把握する。
-   **リグレッションテスト**: コード変更が戦略のパフォーマンスに意図しない悪影響を与えていないかを確認する。

## 2. 基本アーキテクチャ

バックテスト環境は、実際のエージェントのロジックを可能な限りそのまま利用し、外部依存（証券会社API）のみをモックに置き換える構成とする。

-   **バックテスト実行エンジン (Backtest Engine)**:
    -   バックテスト全体の実行を管理するメインプロセス。
    -   データソースから履歴データを1ステップずつ読み込み、エージェントの`tick()`メソッドを呼び出す。
-   **データソース (Data Source)**:
    -   バックテストに使用する履歴価格データ（OHLCV）を提供する。
    -   初期実装ではCSVファイルを想定する。
-   **バックテスト用TradeService (BacktestTradeService)**:
    -   `agent.TradeService`インターフェースを実装した、バックテスト専用のモックサービス。
    -   証券会社APIの代わりに、内部で擬似的な口座残高、ポジション、注文約定を管理する。
-   **エージェント (Agent)**:
    -   取引戦略の意思決定ロジック。バックテスト時も本番稼働時と同一のコードを利用する。
-   **結果レポーター (Result Reporter)**:
    -   バックテスト実行中の取引履歴や資産推移を記録し、テスト終了後にパフォーマンス指標を計算・表示する。

## 3. データソース

-   **形式**: 銘柄コードごとのCSVファイル。
    -   ファイル名例: `7203_history.csv`
    -   カラム: `datetime`, `open`, `high`, `low`, `close`, `volume`
-   **粒度**: 初期実装では日足を想定するが、将来的には分足などにも対応できる設計とする。
-   **データ供給**: 実行エンジンは、シミュレーションのタイムスタンプに対応する価格データをデータソースから取得し、`BacktestTradeService`に供給する。

## 4. バックテスト用TradeService

`BacktestTradeService`は`agent.TradeService`インターフェースを実装し、以下の責務を持つ。

-   `GetPrice(symbol)`: 現在のシミュレーション時刻における、指定銘柄の価格（例: 終値）を返す。
-   `GetPriceHistory(symbol, days)`: 現在のシミュレーション時刻より過去の履歴データを返す。
-   `GetBalance()`: 内部で管理する擬似的な口座残高を返す。
-   `GetPositions()`: 内部で管理する擬似的な保有ポジションを返す。
-   `PlaceOrder(req)`:
    -   成行注文の場合、現在の価格で即座に約定したものとして処理する（スリッページは初期実装では考慮しない）。
    -   約定に伴い、擬似的な口座残高（買付余力）とポジション情報を更新する。
    -   すべての取引履歴（エントリー、エグジット）を記録する。

## 5. 実行エンジン

-   **入力**: バックテスト期間、対象銘柄リスト、初期資金。
-   **処理フロー**:
    1.  `BacktestTradeService`と`Agent`を初期化する。
    2.  指定されたバックテスト期間の開始から終了まで、時間ステップ（例: 1日）ごとにループを実行する。
    3.  ループの各ステップで、データソースからその時点の価格情報を取得し、`BacktestTradeService`の内部状態を更新する。
    4.  エージェントの`tick()`メソッドを呼び出す。
    5.  `tick()`内で`PlaceOrder`が呼ばれた場合、`BacktestTradeService`がそれを処理し、取引結果を記録する。
    6.  ループ終了後、結果レポーターを呼び出し、最終的なパフォーマンス指標を表示する。

## 6. 評価指標

バックテスト終了時に、少なくとも以下の指標を計算・表示する。

-   **総損益 (Total Net Profit)**
-   **プロフィットファクター (Profit Factor)**: 総利益 / 総損失
-   **勝率 (Win Rate)**
-   **総取引回数 (Total Trades)**
-   **最大ドローダウン (Max Drawdown)**
-   **資産推移グラフ (Equity Curve)**: 日々の資産価値の推移。

## 7. 実装ステップ (案)

1.  **Step 1: データソースの準備**
    -   特定の銘柄の履歴価格データをCSV形式で準備する。
    -   CSVを読み込むためのパーサーを実装する。
2.  **Step 2: `BacktestTradeService`の実装**
    -   `agent.TradeService`インターフェースを満たす`BacktestTradeService`構造体を実装する。まずは単純な成行注文の即時約定ロジックから着手する。
3.  **Step 3: 実行エンジンの実装**
    -   バックテスト用の新しいコマンド (`cmd/backtester/main.go`) を作成する。
    -   履歴データをループし、`Agent.tick()`を呼び出すメインループを実装する。
4.  **Step 4: 結果レポーターの実装**
    -   取引履歴と資産推移を記録し、テスト終了後に基本的な評価指標（総損益、取引回数）を表示する機能を実装する。
5.  **Step 5: 評価指標の拡充**
    -   プロフィットファクターや最大ドローダウンなど、より高度な評価指標の計算ロジックを追加する。
