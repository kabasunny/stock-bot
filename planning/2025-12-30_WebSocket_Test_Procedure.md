# 2025年12月30日 WebSocket接続テスト手順書

## 1. テストの目的
立花証券APIのWebSocket（イベントインターフェース）から送られてくる、以下のリアルタイムイベントのメッセージの具体的なフォーマット（キーと値のペア）を特定する。
- **約定通知 (`p_cmd: EX`)**
- **時価配信 (`p_cmd: FD`)**
- **ステータス通知 (`p_cmd: ST`)**

## 2. フェーズ1: デモURLでの接続テスト
まず、電話認証が不要なデモ環境で、基本的な接続とイベント受信が可能かを確認します。

### 準備
1.  **`.env`ファイルの確認**: `.env`ファイルを開き、`TACHIBANA_BASE_URL` が**デモ環境のURL**に設定されていることを確認してください。
2.  **データベースの起動**: `docker compose up -d` を実行し、データベースコンテナを起動します。
3.  **マイグレーションの実行**: `go run ./cmd/migrator/main.go` を実行し、データベースのスキーマを最新化します。

### 実行手順
1.  **アプリケーションの起動**:
    ターミナルで以下のコマンドを実行し、アプリケーションを起動します。
    ```bash
    go run ./cmd/myapp/main.go
    ```
2.  **接続の確認**:
    ログに `"event watcher connected to WebSocket"` というメッセージが出力されることを確認します。
3.  **イベントの観察**:
    デモ環境の仕様上、実際の取引は発生しないため、**約定通知(`EX`)が受信できるかは不明です**。
    ただし、接続状態を示すステータス通知(`ST`)や、ダミーの時価配信(`FD`)などが受信できる可能性があります。しばらくアプリケーションを起動したまま、どのようなイベントがログに出力されるかを観察してください。
4.  **ログの収集**:
    `"received websocket event"` というログが出力された場合、その**ログエントリ全体（特に`raw_message`か`details`の内容）**をコピーして保存してください。

## 3. フェーズ2: 本番URLでの接続テスト
次に、本番環境に接続し、本命である約定通知のフォーマットを特定します。

### 準備
1.  **`.env`ファイルの切り替え**: `.env`ファイルを開き、`TACHIBANA_BASE_URL` を**本番環境のURL**に設定してください。
2.  **電話認証の実施**:
    **【最重要】** アプリケーションを起動する**直前（3分以内）**に、登録済みの電話番号から指定の認証用番号へ電話を発信し、電話認証を完了させてください。
3.  **テスト注文の準備**:
    約定通知を確実に受信するため、テスト対象の口座で、実際に少額の注文を発注・約定させる準備をお願いします（例：証券会社のWebサイトを開いておくなど）。

### 実行手順
1.  **アプリケーションの起動**:
    ターミナルで以下のコマンドを実行します。
    ```bash
    go run ./cmd/myapp/main.go
    ```
2.  **接続の確認**:
    ログに `"event watcher connected to WebSocket"` メッセージが出力されることを確認します。
3.  **テスト注文の実行**:
    WebSocket接続が確立されたのを確認後、準備しておいた**テスト注文を発注し、約定させてください。**
4.  **ログの収集**:
    ターミナルに出力されるログを注意深く監視し、`"command": "EX"` を含むログエントリを探します。その**ログエントリ全体（特に`raw_message`か`details`の内容）**をコピーして保存してください。`FD`や`ST`など、他のイベントも受信できれば、同様に保存してください。

## 4. 結果の報告
フェーズ1およびフェーズ2で収集した各イベントのログ（`EX`, `FD`, `ST`など）を、次のステップで私に提供してください。
いただいた情報に基づき、各イベントハンドラのパーサーを完成させ、リアルタイム処理機能を最終実装します。
